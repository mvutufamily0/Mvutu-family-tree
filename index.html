<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Famille MVUTU — Arbre & Profils</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#111829;
      --panel2:rgba(255,255,255,.05);
      --line:rgba(255,255,255,.12);
      --text:#eef2ff;
      --muted:#9aa4b2;
      --accent:#7c3aed;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1000px 600px at 15% -10%, rgba(124,58,237,.26), transparent),
        radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.14), transparent),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.35;
    }
    a{color:inherit}
    .wrap{max-width:1150px;margin:0 auto;padding:18px}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(11,15,25,.85), rgba(11,15,25,.55));
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
      padding:14px 18px;
      max-width:1150px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:flex-start; gap:12px;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.95), rgba(124,58,237,.25));
      border:1px solid rgba(124,58,237,.35);
      box-shadow:0 18px 40px rgba(0,0,0,.25);
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:4px 0 0;color:var(--muted);font-size:12.5px}
    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .btn{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      user-select:none;
      font-size:14px;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:rgba(124,58,237,.18);
      border-color:rgba(124,58,237,.35);
    }
    .btn.danger{
      background:rgba(239,68,68,.14);
      border-color:rgba(239,68,68,.35);
    }
    input[type="search"], input[type="password"], textarea{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }
    input[type="search"]{min-width:280px;flex:1 1 320px}
    textarea{width:100%;min-height:120px;resize:vertical}
    .grid{display:grid;gap:14px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(124,58,237,.14);
      border:1px solid rgba(124,58,237,.28);
      font-size:12px; color:rgba(238,242,255,.95);
    }
    .tag{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:rgba(238,242,255,.9);
      background:rgba(255,255,255,.04);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .tag.spouse{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12)}
    .tag.deceased{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12)}
    .tag.parents{border-color:rgba(124,58,237,.35); background:rgba(124,58,237,.12)}
    .tag.child{border-color:rgba(255,255,255,.16)}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .tree{
      margin-top:10px;
      padding:10px 10px 6px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:auto;
    }
    ul{
      list-style:none;
      padding-left:22px;
      margin:6px 0;
      border-left:1px dashed rgba(255,255,255,.16);
    }
    li{position:relative;padding:6px 0 6px 12px}
    li::before{
      content:"";
      position:absolute; left:-1px; top:18px;
      width:12px; border-top:1px dashed rgba(255,255,255,.16);
    }
    details{border-radius:14px;padding:4px 6px}
    summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 8px;
      border-radius:14px;
      transition: background .15s;
    }
    summary::-webkit-details-marker{display:none}
    summary:hover{background:rgba(255,255,255,.05)}
    .node{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .name{font-weight:650;letter-spacing:.2px}
    .count{color:rgba(154,164,178,.9);font-size:12px;margin-left:auto}
    mark{background:rgba(124,58,237,.28);color:var(--text);padding:0 3px;border-radius:5px}
    .kpi{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px
    }
    .kpi .mini{
      padding:12px;border-radius:18px;border:1px solid var(--line);
      background:rgba(255,255,255,.04)
    }
    .mini .big{font-size:18px;font-weight:750;margin:0}
    .mini .small{margin:4px 0 0;color:var(--muted);font-size:12px}
    .profile{
      display:grid; gap:14px;
      grid-template-columns: 320px 1fr;
    }
    @media (max-width: 920px){
      .profile{grid-template-columns:1fr}
      .kpi{grid-template-columns:1fr}
    }
    .avatar{
      width:100%; aspect-ratio: 4/3;
      border-radius:22px;
      border:1px solid var(--line);
      background:
        radial-gradient(circle at 30% 30%, rgba(124,58,237,.26), transparent),
        rgba(255,255,255,.03);
      display:flex; align-items:center; justify-content:center;
      color:rgba(154,164,178,.9);
      text-align:center;
      padding:14px;
    }
    .links{display:flex;gap:10px;flex-wrap:wrap}
    .smallnote{font-size:12px;color:rgba(154,164,178,.9)}
    .lockscreen{
      min-height:100dvh;
      display:flex;align-items:center;justify-content:center;
      padding:18px;
    }
    .lockcard{
      width:min(520px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:26px;
      padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
    }
    .error{color:#fecaca}
    .success{color:#bbf7d0}
  </style>
</head>
<body>

<header id="appHeader" style="display:none;">
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 id="titleTxt">Famille MVUTU — Arbre & Profils</h1>
        <div class="sub" id="subtitleTxt">Recherche, branches, et fiches individuelles.</div>
      </div>
    </div>

    <div class="bar">
      <input id="search" type="search" placeholder="Rechercher un nom… (ex: William, Mateza, Bafundila)" />
      <button class="btn" id="navTree">Arbre</button>
      <button class="btn" id="navDirectory">Annuaire</button>
      <button class="btn" id="langBtn">FR</button>
      <button class="btn" id="expandAll">Tout déplier</button>
      <button class="btn" id="collapseAll">Tout replier</button>
      <button class="btn danger" id="lockBtn">Verrouiller</button>
    </div>
  </div>
</header>

<!-- LOCK SCREEN -->
<section class="lockscreen" id="lockScreen">
  <div class="lockcard">
    <div class="row" style="justify-content:space-between;">
      <div>
        <h1 style="font-size:20px;margin:0;">Accès privé</h1>
        <p class="sub" style="margin:6px 0 0;">
          Entre le mot de passe pour voir l’arbre généalogique.
        </p>
      </div>
      <span class="pill">V2</span>
    </div>

    <div class="divider"></div>

    <div class="grid">
      <label class="muted" for="pass">Mot de passe</label>
      <input id="pass" type="password" placeholder="••••••••" />
      <button class="btn primary" id="unlockBtn">Déverrouiller</button>
      <div class="smallnote" id="lockHint"></div>
      <div id="lockMsg" class="error"></div>

      <div class="divider"></div>

      <details>
        <summary class="muted">Changer le mot de passe (optionnel)</summary>
        <p class="smallnote" style="margin:10px 0 6px;">
          Change-le dans le code : <strong>CONFIG.PASSWORD</strong>. (Client-side)
        </p>
        <pre style="white-space:pre-wrap;color:rgba(238,242,255,.9);background:rgba(0,0,0,.2);border:1px solid var(--line);padding:12px;border-radius:16px;margin:0;">
const CONFIG = { PASSWORD: "MVUTU2026" };
        </pre>
      </details>
    </div>
  </div>
</section>

<main class="wrap" id="app" style="display:none;">
  <section class="card" id="homeCard">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="row" style="gap:10px;">
          <h2 style="margin:0;font-size:16px;" id="sectionTitle">Arbre</h2>
          <span class="pill" id="statusPill">Privé</span>
        </div>
        <p class="muted" style="margin:8px 0 0;" id="sectionDesc">
          Clique sur un nom pour déplier/replier. Utilise la recherche pour filtrer.
        </p>
      </div>
    </div>

    <div class="divider"></div>

    <div class="kpi" id="kpis"></div>

    <div class="divider"></div>

    <!-- ROUTED CONTENT -->
    <div id="view"></div>
  </section>
</main>

<script>
/* =========================
   CONFIG (EDIT THIS)
========================= */
const CONFIG = {
  PASSWORD: "MVUTU2026", // <-- Change ici
  BRAND_TITLE_FR: "Famille MVUTU — Arbre & Profils",
  BRAND_TITLE_EN: "MVUTU Family — Tree & Profiles",
};

/* =========================
   DATA (EDITABLE JSON)
========================= */
const rawTree = {
  id: "marcel-mvutu",
  name: "Marcel MVUTU Kuetutinina",
  deceased: false,
  spouse: { name: "Thérèse Bafundila MAYANGI", deceased: false },
  parents: [
    { name: "BAKITANGA", deceased: false },
    { name: "MELE", deceased: false },
  ],
  siblings: [
    { relation: "Jeune frère", name: "Grégoire SAKUBA", deceased: false },
    { relation: "Grande-sœur", name: "Ma SEMI", deceased: false },
  ],
  children: [
    {
      id:"A",
      label:"A",
      name: "Florence VUVU MIATUATAMBUDILA MVUTU",
      spouse: { name: "Seraphin MATEZA" },
      children: [
        { name: "Arsène", deceased: true },
        {
          name: "Noranìe MATEZA",
          spouse: { name: "Raphaël Mpanu Mpanu Bibanda" },
          children: [
            { name: "Jéhovah rapha MATEZA" },
            { name: "Éminence Mpanu" },
            { name: "Orgi Vuvu" }
          ]
        },
        { name: "Derrick MATEZA" },
        {
          name: "Diazuna Mateza Keren",
          spouse: { name: "Dieudonné Nzila Zengamambu" }
        },
        { name: "Tychique MATEZA" },
        { name: "Ben Éloge MATEZA" }
      ]
    },

    {
      id:"B",
      label:"B",
      name: "Florian Prudhomme BAKITANGA MVUTU",
      spouse: { name: "Vicky MAMBOTE" },
      children: [
        { name: "Bueso NSAYI (JOY) MVUTU", spouse: { name: "Cedrick BALISENT" } },
        { name: "Gedeon MVUTU" },
        { name: "David MVUTU", spouse: { name: "Dorcas NZAI BOKIE" } },
        { name: "Florence MAMBOTE MVUTU" }
      ]
    },

    {
      id:"C",
      label:"C",
      name: "Placide MAKOLAVUMA MVUTU",
      spouse: { name: "Bahanungu Ami MANDUKI" },
      children: [
        { name: "Abraham Lincoln Kuetutinina MVUTU" },
        { name: "William Ami Elijah MVUTU" },
        { name: "Salem Manduki MVUTU" }
      ]
    },

    {
      id:"D",
      label:"D",
      name: "Eddie-le-jour NZINGULA",
      spouse: { name: "Samuel NDEBO", deceased: true },
      children: [
        {
          name: "Magloire Bebiki NDEBO",
          spouse: { name: "Olivier Maluku Mbomba" },
          children: [
            { name: "Moïse Maluku Mbomba" },
            { name: "Samuel Maluku Mbomba" }
          ]
        },
        { name: "Corneille NDEBO" },
        { name: "Abigaël BAFUNDILA NDEBO" }
      ]
    },

    {
      id:"E",
      label:"E",
      name: "Flavien Mayangi",
      spouse: { name: "Annie MBAYABU ILUNGA" },
      children: [
        { name: "Emmanuel BAKITANGA MVUTU" },
        { name: "Joseph ILUNGA MVUTU" },
        { name: "Anna BAFUNDILA MVUTU" },
        { name: "Elijah Tutinina Mu Yesu Klisto MVUTU" }
      ]
    },

    {
      id:"F",
      label:"F",
      name: "Mireille BASOLUKA MVUTU",
      spouse: { name: "PÉPÉ BANZA" },
      children: [
        { name: "Grâce Nehema Banza" },
        { name: "Divine Basoluka Banza" },
        { name: "Sifa Kalume Banza" },
        { name: "Peace Amani Banza" }
      ]
    },

    {
      id:"G",
      label:"G",
      name: "EYO Josué MVUTU",
      deceased: true,
      spouse: { name: "Nadia MABANZA" },
      children: [
        { name: "Manassé-Winner MAYANGI MA MVUTU" },
        { name: "Amélia HOPE MVUTU" },
        { name: "Michael MVUTU" },
        { name: "Gabriel Branson MVUTU" }
      ]
    },

    { id:"H", label:"H", name: "Nsayi Bueso Sylvie", deceased: true },
    { id:"I", label:"I", name: "Gênérose BAKUNDIKA MVUTU" }
  ]
};

/* =========================
   i18n STRINGS
========================= */
const I18N = {
  fr: {
    brandTitle: CONFIG.BRAND_TITLE_FR,
    brandSub: "Recherche, branches, et fiches individuelles.",
    tree: "Arbre",
    directory: "Annuaire",
    private: "Privé",
    clickHint: "Clique sur un nom pour déplier/replier. Utilise la recherche pour filtrer.",
    statsPeople: "Personnes",
    statsBranches: "Branches",
    statsDeceased: "Décédés (†)",
    patriarch: "Patriarche",
    spouse: "époux/épouse",
    parents: "Parents",
    siblings: "Fratrie",
    children: "Enfants",
    back: "Retour",
    openProfile: "Ouvrir la fiche",
    notFound: "Aucun résultat.",
    notes: "Notes (optionnel)",
    saveNotes: "Sauvegarder",
    saved: "Sauvegardé ✓",
    searchPh: "Rechercher un nom…",
  },
  en: {
    brandTitle: CONFIG.BRAND_TITLE_EN,
    brandSub: "Search, branches, and individual profiles.",
    tree: "Tree",
    directory: "Directory",
    private: "Private",
    clickHint: "Click a name to expand/collapse. Use search to filter.",
    statsPeople: "People",
    statsBranches: "Branches",
    statsDeceased: "Deceased (†)",
    patriarch: "Patriarch",
    spouse: "spouse",
    parents: "Parents",
    siblings: "Siblings",
    children: "Children",
    back: "Back",
    openProfile: "Open profile",
    notFound: "No results.",
    notes: "Notes (optional)",
    saveNotes: "Save",
    saved: "Saved ✓",
    searchPh: "Search a name…",
  }
};

/* =========================
   UTILITIES
========================= */
const $ = (sel) => document.querySelector(sel);
function escapeHtml(str=""){
  return str.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function highlight(text, q){
  if(!q) return escapeHtml(text);
  const t = text || "";
  const idx = t.toLowerCase().indexOf(q.toLowerCase());
  if(idx === -1) return escapeHtml(t);
  const before = escapeHtml(t.slice(0, idx));
  const match  = escapeHtml(t.slice(idx, idx+q.length));
  const after  = escapeHtml(t.slice(idx+q.length));
  return `${before}<mark>${match}</mark>${after}`;
}
function slugify(s){
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")
    .slice(0,70);
}
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

/* =========================
   BUILD DIRECTORY (unique ids)
========================= */
const tree = deepClone(rawTree);
const people = new Map(); // id => person

function addPerson(p, meta={}){
  // Create stable-ish id from name + optional branch label + optional parent
  const base = slugify(p.name || "unknown");
  const hint = meta.hint ? "-" + slugify(meta.hint) : "";
  let id = base + hint;
  let i = 2;
  while(people.has(id)) { id = base + hint + "-" + i; i++; }

  const person = {
    id,
    name: p.name,
    deceased: !!p.deceased,
    spouse: p.spouse ? { name: p.spouse.name, deceased: !!p.spouse.deceased } : null,
    branch: meta.branch || null,
    label: meta.label || null,
    // links below filled later
    parents: [],
    children: [],
  };
  people.set(id, person);
  return person;
}

function traverseBuild(node, meta, parentId=null){
  const person = addPerson(node, { branch: meta.branch, label: meta.label, hint: meta.hint });
  if(parentId){
    person.parents.push(parentId);
    people.get(parentId).children.push(person.id);
  }

  // spouse as "linked string" (not separate person unless you want later)
  if(Array.isArray(node.children)){
    node.children.forEach((child, idx) => {
      traverseBuild(child, { branch: meta.branch, label: meta.label, hint: (meta.hint||"")+ "-child"+(idx+1) }, person.id);
    });
  }
  return person.id;
}

// Patriarch is a person too
const patriarchId = addPerson({ name: tree.name, deceased: tree.deceased }, { branch: "Patriarch", label: "P", hint:"patriarch" }).id;

// attach children as branches A..I under patriarch
(tree.children||[]).forEach((child, idx) => {
  const label = child.label || String.fromCharCode(65+idx);
  traverseBuild(child, { branch: label, label, hint:"branch-"+label }, patriarchId);
});

// Stats
function stats(){
  let total = people.size;
  let deceased = 0;
  for(const p of people.values()) if(p.deceased) deceased++;
  // branches = unique labels excluding P
  const branches = new Set();
  for(const p of people.values()){
    if(p.label && p.label !== "P") branches.add(p.label);
  }
  return { total, deceased, branches: branches.size };
}

/* =========================
   SIMPLE NOTES (localStorage)
========================= */
function notesKey(personId){ return "mvutu_notes_"+personId; }
function loadNotes(personId){ return localStorage.getItem(notesKey(personId)) || ""; }
function saveNotes(personId, txt){ localStorage.setItem(notesKey(personId), txt); }

/* =========================
   AUTH (localStorage)
========================= */
const AUTH_KEY = "mvutu_unlocked_v2";
function isUnlocked(){ return localStorage.getItem(AUTH_KEY) === "1"; }
function lock(){ localStorage.removeItem(AUTH_KEY); }
function unlock(){ localStorage.setItem(AUTH_KEY, "1"); }

/* =========================
   APP STATE
========================= */
let lang = (localStorage.getItem("mvutu_lang") || "fr");
function t(){ return I18N[lang]; }
function setLang(next){
  lang = next;
  localStorage.setItem("mvutu_lang", lang);
  renderShell();
  route();
}

/* =========================
   RENDER SHELL
========================= */
function renderShell(){
  $("#titleTxt").textContent = t().brandTitle;
  $("#subtitleTxt").textContent = t().brandSub;
  $("#langBtn").textContent = lang.toUpperCase();
  $("#navTree").textContent = t().tree;
  $("#navDirectory").textContent = t().directory;
  $("#statusPill").textContent = t().private;
  $("#sectionDesc").textContent = t().clickHint;
  $("#search").placeholder = t().searchPh;
  document.title = t().brandTitle;

  // KPIs
  const s = stats();
  $("#kpis").innerHTML = `
    <div class="mini">
      <p class="big">${s.total}</p>
      <p class="small">${t().statsPeople}</p>
    </div>
    <div class="mini">
      <p class="big">${s.branches}</p>
      <p class="small">${t().statsBranches}</p>
    </div>
    <div class="mini">
      <p class="big">${s.deceased}</p>
      <p class="small">${t().statsDeceased}</p>
    </div>
  `;
}

/* =========================
   ROUTING (hash)
   #tree
   #dir
   #person/<id>
========================= */
function go(hash){ location.hash = hash; }
function currentHash(){ return (location.hash || "#tree"); }

/* =========================
   TREE RENDER (interactive)
========================= */
function setAllDetails(open){
  document.querySelectorAll("details").forEach(d => d.open = open);
}

function subtreeHasMatchNode(node, q){
  // node: raw tree node structure for the displayed tree (we use rawTree)
  if(!q) return true;
  const target = [
    node.name||"",
    node.spouse?.name||""
  ].join(" ").toLowerCase();
  if(target.includes(q.toLowerCase())) return true;
  if(Array.isArray(node.children)) return node.children.some(c => subtreeHasMatchNode(c, q));
  return false;
}

function renderNodeRaw(node, query){
  const hasKids = Array.isArray(node.children) && node.children.length > 0;
  const visible = query ? subtreeHasMatchNode(node, query) : true;
  const li = document.createElement("li");
  if(!visible){
    li.style.display = "none";
    return li;
  }

  const deceasedBadge = node.deceased ? `<span class="tag deceased">†</span>` : "";
  const spouseBadge = node.spouse?.name ? `<span class="tag spouse">${t().spouse}: ${escapeHtml(node.spouse.name)}${node.spouse.deceased ? " †" : ""}</span>` : "";

  // Find directory id to link profile (best-effort by name match)
  const dirId = findPersonIdByName(node.name);
  const openBtn = dirId ? `<button class="btn" style="padding:6px 10px;font-size:12px;" data-open="${dirId}">${t().openProfile}</button>` : "";

  if(hasKids){
    const d = document.createElement("details");
    if(query) d.open = true;
    const s = document.createElement("summary");
    s.innerHTML = `
      <span class="node">
        <span class="name">${highlight(node.name, query)}</span>
        ${deceasedBadge}
        ${spouseBadge}
        <span class="count">${node.children.length} ${t().children.toLowerCase()}</span>
      </span>
      ${openBtn}
    `;
    const ul = document.createElement("ul");
    node.children.forEach(k => ul.appendChild(renderNodeRaw(k, query)));
    d.appendChild(s);
    d.appendChild(ul);
    li.appendChild(d);
  } else {
    li.innerHTML = `
      <div class="node">
        <span class="name">${highlight(node.name, query)}</span>
        ${deceasedBadge}
        ${spouseBadge}
        ${openBtn}
      </div>
    `;
  }
  return li;
}

function findPersonIdByName(name){
  if(!name) return null;
  const n = name.trim().toLowerCase();
  // exact match first
  for(const p of people.values()){
    if((p.name||"").trim().toLowerCase() === n) return p.id;
  }
  // contains match fallback
  for(const p of people.values()){
    if((p.name||"").toLowerCase().includes(n)) return p.id;
  }
  return null;
}

function renderTreeView(query){
  const view = $("#view");
  $("#sectionTitle").textContent = t().tree;
  view.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <div class="tag parents">${t().patriarch}: ${escapeHtml(tree.name)}${tree.deceased ? " †" : ""}</div>
        <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap;">
          ${tree.spouse?.name ? `<span class="tag spouse">${t().spouse}: ${escapeHtml(tree.spouse.name)}${tree.spouse.deceased ? " †" : ""}</span>` : ""}
          ${tree.parents?.length ? `<span class="tag parents">${t().parents}: ${tree.parents.map(p => escapeHtml(p.name)+(p.deceased?" †":"")).join(" & ")}</span>` : ""}
          ${tree.siblings?.length ? `<span class="tag">${t().siblings}: ${tree.siblings.map(s => escapeHtml(s.relation+" — "+s.name)+(s.deceased?" †":"")).join(" • ")}</span>` : ""}
        </div>
      </div>
    </div>

    <div class="tree" id="treeBox"></div>
    <p class="smallnote" style="margin:10px 0 0;">
      ${t().clickHint} — ${t().statsDeceased}
    </p>
  `;

  const treeBox = $("#treeBox");
  const ul = document.createElement("ul");
  (tree.children||[]).forEach(child => ul.appendChild(renderNodeRaw(child, query)));
  treeBox.appendChild(ul);

  // bind open profile buttons
  view.querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const id = e.currentTarget.getAttribute("data-open");
      go("#person/" + id);
    });
  });
}

/* =========================
   DIRECTORY VIEW
========================= */
function renderDirectory(query){
  $("#sectionTitle").textContent = t().directory;
  const view = $("#view");

  // build list sorted
  const arr = Array.from(people.values()).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  const q = (query||"").trim().toLowerCase();
  const filtered = q ? arr.filter(p=>{
    const target = [p.name, p.spouse?.name, p.branch, p.label].filter(Boolean).join(" ").toLowerCase();
    return target.includes(q);
  }) : arr;

  if(filtered.length === 0){
    view.innerHTML = `<div class="muted">${t().notFound}</div>`;
    return;
  }

  view.innerHTML = `
    <div class="grid" style="gap:10px;">
      ${filtered.map(p=>`
        <div class="card" style="padding:14px;">
          <div class="row" style="justify-content:space-between;align-items:flex-start;">
            <div>
              <div class="row" style="gap:8px;">
                <div class="name">${escapeHtml(p.name)} ${p.deceased ? `<span class="tag deceased">†</span>`:""}</div>
                ${p.label && p.label!=="P" ? `<span class="tag">Branche ${escapeHtml(p.label)}</span>` : (p.label==="P" ? `<span class="tag parents">${t().patriarch}</span>` : "")}
              </div>
              <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap;">
                ${p.spouse?.name ? `<span class="tag spouse">${t().spouse}: ${escapeHtml(p.spouse.name)}${p.spouse.deceased ? " †":""}</span>` : ""}
                ${p.parents.length ? `<span class="tag">${t().parents}: ${p.parents.map(id=>escapeHtml(people.get(id)?.name||"")).join(" • ")}</span>` : ""}
                ${p.children.length ? `<span class="tag child">${t().children}: ${p.children.length}</span>` : ""}
              </div>
            </div>
            <div class="links">
              <button class="btn primary" data-person="${p.id}">${t().openProfile}</button>
            </div>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  view.querySelectorAll("[data-person]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      go("#person/" + e.currentTarget.getAttribute("data-person"));
    });
  });
}

/* =========================
   PROFILE VIEW
========================= */
function renderProfile(personId){
  const p = people.get(personId);
  const view = $("#view");

  if(!p){
    view.innerHTML = `<div class="muted">${t().notFound}</div>`;
    return;
  }

  $("#sectionTitle").textContent = escapeHtml(p.name);

  const parents = p.parents.map(id=>people.get(id)).filter(Boolean);
  const children = p.children.map(id=>people.get(id)).filter(Boolean);

  const notes = loadNotes(p.id);

  view.innerHTML = `
    <div class="profile">
      <div class="grid">
        <div class="avatar">
          <div>
            <div style="font-weight:750;font-size:14px;">Photo / Vidéo</div>
            <div class="smallnote" style="margin-top:6px;">
              (V3: upload photos, archives, audio interviews)
            </div>
          </div>
        </div>

        <div class="card" style="padding:14px;">
          <div class="row" style="justify-content:space-between;align-items:flex-start;">
            <div>
              <div class="row" style="gap:10px;">
                <div class="name" style="font-size:16px;">${escapeHtml(p.name)}</div>
                ${p.deceased ? `<span class="tag deceased">†</span>` : ``}
                ${p.label && p.label!=="P" ? `<span class="tag">Branche ${escapeHtml(p.label)}</span>` : (p.label==="P" ? `<span class="tag parents">${t().patriarch}</span>` : "")}
              </div>

              <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap;">
                ${p.spouse?.name ? `<span class="tag spouse">${t().spouse}: ${escapeHtml(p.spouse.name)}${p.spouse.deceased ? " †":""}</span>` : `<span class="tag muted">${t().spouse}: —</span>`}
              </div>
            </div>
            <button class="btn" id="backBtn">${t().back}</button>
          </div>

          <div class="divider"></div>

          <div class="grid" style="gap:10px;">
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px;">${t().parents}</div>
              <div class="row" style="gap:8px;flex-wrap:wrap;">
                ${parents.length ? parents.map(pp=>`<button class="btn" style="padding:7px 10px;font-size:12px;" data-go="${pp.id}">${escapeHtml(pp.name)}</button>`).join("") : `<span class="muted">—</span>`}
              </div>
            </div>

            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px;">${t().children}</div>
              <div class="row" style="gap:8px;flex-wrap:wrap;">
                ${children.length ? children.map(cc=>`<button class="btn" style="padding:7px 10px;font-size:12px;" data-go="${cc.id}">${escapeHtml(cc.name)}${cc.deceased?" †":""}</button>`).join("") : `<span class="muted">—</span>`}
              </div>
            </div>

            <div>
              <div class="muted" style="font-size:12px;margin-bottom:6px;">${t().notes}</div>
              <textarea id="notesBox" placeholder="Ex: lieu de naissance, histoire, dates, photos à ajouter…">${escapeHtml(notes)}</textarea>
              <div class="row" style="justify-content:space-between;">
                <button class="btn primary" id="saveNotesBtn">${t().saveNotes}</button>
                <span class="smallnote" id="saveMsg"></span>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2 style="margin:0 0 8px;font-size:14px;">Branching</h2>
          <p class="muted" style="margin:0;">
            V3 possible: dates, lieux, carte de migration, galerie photos, export GEDCOM/CSV, accès multi-utilisateurs.
          </p>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px;font-size:14px;">Accès rapide</h2>
          <div class="row">
            <button class="btn" onclick="go('#tree')">${t().tree}</button>
            <button class="btn" onclick="go('#dir')">${t().directory}</button>
          </div>
        </div>
      </div>
    </div>
  `;

  $("#backBtn").addEventListener("click", ()=>{
    // back to dir if coming from there? keep simple:
    if(history.length > 1) history.back();
    else go("#dir");
  });

  view.querySelectorAll("[data-go]").forEach(b=>{
    b.addEventListener("click",(e)=> go("#person/" + e.currentTarget.getAttribute("data-go")));
  });

  $("#saveNotesBtn").addEventListener("click", ()=>{
    const txt = $("#notesBox").value || "";
    saveNotes(p.id, txt);
    $("#saveMsg").textContent = t().saved;
    $("#saveMsg").className = "success smallnote";
    setTimeout(()=> { if($("#saveMsg")) $("#saveMsg").textContent=""; }, 1500);
  });
}

/* =========================
   ROUTE HANDLER
========================= */
function route(){
  const hash = currentHash();
  const q = ($("#search").value || "").trim();

  if(hash.startsWith("#person/")){
    const id = hash.slice("#person/".length);
    renderProfile(id);
    return;
  }
  if(hash === "#dir"){
    renderDirectory(q);
    return;
  }
  // default
  renderTreeView(q);
}

/* =========================
   EVENTS
========================= */
function initApp(){
  // auth gate
  if(!isUnlocked()){
    $("#lockScreen").style.display = "flex";
    $("#appHeader").style.display = "none";
    $("#app").style.display = "none";
    $("#lockHint").textContent = `Mot de passe actuel (exemple): ${CONFIG.PASSWORD}`;
    return;
  }

  $("#lockScreen").style.display = "none";
  $("#appHeader").style.display = "block";
  $("#app").style.display = "block";

  renderShell();
  route();
}

window.addEventListener("hashchange", route);

$("#unlockBtn").addEventListener("click", ()=>{
  const val = ($("#pass").value || "").trim();
  if(val === CONFIG.PASSWORD){
    unlock();
    $("#lockMsg").textContent = "";
    initApp();
    // go to tree on unlock
    if(!location.hash) location.hash = "#tree";
  } else {
    $("#lockMsg").textContent = "Mot de passe incorrect.";
  }
});

$("#pass").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") $("#unlockBtn").click();
});

$("#lockBtn").addEventListener("click", ()=>{
  lock();
  location.hash = "#tree";
  initApp();
});

$("#langBtn").addEventListener("click", ()=>{
  setLang(lang === "fr" ? "en" : "fr");
});

$("#navTree").addEventListener("click", ()=> go("#tree"));
$("#navDirectory").addEventListener("click", ()=> go("#dir"));

$("#expandAll").addEventListener("click", ()=> setAllDetails(true));
$("#collapseAll").addEventListener("click", ()=> setAllDetails(false));

$("#search").addEventListener("input", ()=>{
  // rerender current view with filter
  route();
});

/* Boot */
initApp();
</script>

</body>
</html>